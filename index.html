
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lead Generator</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Loader Overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #2980b9;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body>
  <div id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <h1>Lead Generator</h1>

  <div class="top-container">
    <form id="searchForm">
      <label>Location (lat,lng):</label><br />
      <input type="text" name="location" value="50.0405,-110.6766" required /><br />

      <label>Radius (meters): <span id="toKm"></span> </label> <br />
      <input id="radius" type="number" name="radius" value="10000" required /><br />

      <label>Business Types:</label><br />
      <div id="typeInput">
        <input type="text" id="typeText" placeholder="Type and press Enter" />
        <div id="typeTags"></div>
      </div>
      <input type="hidden" name="types" id="typesField" /><br />

      <label>Has Website:</label>
      <select name="has_website">
        <option value="both" selected>Both</option>
        <option value="yes" >Yes</option>
        <option value="no">No</option>
      </select><br /><br />

      <button type="submit">Search</button>
      <button type="button" id="exportBtn">Export as CSV</button>
      <h2 id="count" style="margin-top:1rem;"></h2>
    </form>

    <div class="suggested-types-container">
      <h3>Suggested Business Types:</h3>
      <div id="presetTypes"></div>
    </div>
  </div>

  <table id="resultsTable" border="1">
    <thead>
      <tr>
        <th>#</th> 
        <th>Name</th>
        <th>Address</th>
        <th style="width: 200px;">Phone</th>
        <th>Website</th>
        <th>Rating</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let typeList = [];

    const input = document.getElementById('typeText');
    const tagsContainer = document.getElementById('typeTags');
    const hiddenField = document.getElementById('typesField');
    const loadingOverlay = document.getElementById('loadingOverlay');

    const radiusInput = document.getElementById('radius');
    const toKmDisplay = document.getElementById('toKm');

    radiusInput.addEventListener('input', function () {
      const km = (this.value / 1000).toFixed(2);
      toKmDisplay.textContent = `(${km} km)`;
    });
    const presetTypes = [
      'accounting', 'bakery', 'bank', 'bar', 'beauty_salon', 'bicycle_store',
      'book_store', 'car_repair', 'car_wash', 'clothing_store', 'dentist', 'doctor',
      'electrician', 'electronics_store', 'florist', 'furniture_store', 'gym',
      'hair_care', 'hardware_store', 'home_goods_store', 'insurance_agency',
      'jewelry_store', 'laundry', 'lawyer', 'locksmith', 'meal_takeaway',
      'moving_company', 'painter', 'pet_store', 'pharmacy', 'plumber', 'real_estate_agency',
      'roofing_contractor', 'school', 'shoe_store', 'spa', 'storage', 'supermarket',
      'travel_agency', 'veterinary_care'
    ];

    const presetContainer = document.getElementById('presetTypes');
    presetTypes.forEach(type => {
      const btn = document.createElement('button');
      btn.textContent = type.replace(/_/g, ' ');
      btn.type = 'button';
      btn.className = 'preset-btn';
      btn.onclick = () => {
        if (!typeList.includes(type)) {
          typeList.push(type);
          updateTags();
        }
      };
      presetContainer.appendChild(btn);
    });

    input.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const val = input.value.trim().toLowerCase().replace(/\s+/g, '_');
        if (val && !typeList.includes(val)) {
          typeList.push(val);
          updateTags();
        }
        input.value = '';
      }
    });

    function updateTags() {
      tagsContainer.innerHTML = '';
      typeList.forEach((type, index) => {
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = type.replace(/_/g, ' ');

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = 'Ã—';
        removeBtn.onclick = () => {
          typeList.splice(index, 1);
          updateTags();
        };
        tag.appendChild(removeBtn);
        tagsContainer.appendChild(tag);
      });

      hiddenField.value = typeList.join(',');
    }

    document.getElementById('searchForm').onsubmit = async function (e) {
      e.preventDefault();
      loadingOverlay.style.display = 'flex';
      try {
        const formData = new FormData(e.target);
        const params = new URLSearchParams(formData);

        const res = await fetch('api.php?' + params.toString());
        const data = await res.json();

        if (data.length === 0) {
            alert('No results found.');
            table.style.display = 'none';
            countDisplay.textContent = 'Found 0 businesses.';
            return;
        }
        const count = data.length


        const table = document.getElementById('resultsTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          alert('No results found.');
          table.style.display = 'none';
          return;
        }

        data.forEach((biz, index) => {
            const row = `<tr>
                <td>${index + 1}</td>  <!-- Index, starting from 1 -->
                <td>${biz.name}</td>
                <td>${biz.address}</td>
                <td>${biz.phone || ''}</td>
                <td>${biz.website ? `<a href="${biz.website}" target="_blank" rel="noopener">Website</a>` : 'N/A'}</td>
                <td>${biz.rating || ''}</td>
                <td>${biz.status || ''}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        const countDisplay = document.getElementById('count');
        countDisplay.textContent = `Found ${count} businesses.`;
        
        table.style.display = 'table';
      } catch {
        alert('Error fetching data. Please try again.');
      } finally {
        loadingOverlay.style.display = 'none';
      }
    };
    
    document.getElementById('exportBtn').onclick = () => {
      const formData = new FormData(document.getElementById('searchForm'));
      const params = new URLSearchParams(formData);
      params.append('format', 'csv');
      window.open('api.php?' + params.toString(), '_blank');
    };
  </script>
</body>
</html>
